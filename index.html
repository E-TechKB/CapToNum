<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コンデンサコード入力ゲーム</title>

    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            user-select: none;
        }
        .main-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        #game-wrapper {
            position: relative;
        }
        .hidden {
            display: none;
        }
        #start-screen {
            text-align: center;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 370px;
        }
        #start-screen h1 {
            margin-bottom: 15px;
            color: #333;
        }
        #start-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #start-button:hover {
            background-color: #0056b3;
        }
        #game-container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 370px;
            position: relative;
        }
        #countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            font-size: 10rem;
            font-weight: bold;
            color: #007bff;
            border-radius: 15px;
        }
        #countdown-overlay:not(.hidden) {
            display: flex;
        }
        h1 {
            margin-top: 0;
            color: #333;
            font-size: 1.4em;
        }
        #info-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
        }
        #capacitor-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 0px;
            margin-bottom: 25px;
            background-color: #4A5568;
            border-radius: 8px;
        }
        #capacitor-value {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5em;
            font-weight: bold;
            color: #0c0a06;
        }
        #display-panel {
            margin-bottom: 15px;
        }
        #input-display {
            background-color: #e9ecef;
            min-height: 40px;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 2em;
            color: #333;
            letter-spacing: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #feedback {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1.3;
        }
        .correct { color: #28a745; }
        .incorrect { color: #dc3545; }
        #keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .key {
            padding: 18px 0;
            font-size: 1.5em;
            border: none;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .key:active:not(:disabled) {
            background-color: #c6c7c8;
        }
        .clear-key {
            background-color: #ffc107;
        }
        .clear-key:active { background-color: #d39e00; }
        .enter-key {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }
        .enter-key:active { background-color: #218838; }

        #game-over-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #game-over-modal:not(.hidden) {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        #restart-button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
        }
        #sidebar {
            width: 280px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .sidebar-section {
            margin-bottom: 25px;
        }
        .sidebar-section h2 {
            font-size: 1.2em;
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        #today-best-score-wrapper {
            text-align: center;
        }
        .score-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
            margin: 0;
        }
        #ranking-list {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        #ranking-list li {
            font-size: 1.1em;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #ranking-list li:first-child { font-weight: bold; color: #d9534f; }
        #ranking-list li:nth-child(2) { font-weight: bold; color: #f0ad4e; }
        #ranking-list li:nth-child(3) { font-weight: bold; color: #5cb85c; }
        .timestamp {
            font-size: 0.8em;
            color: #888;
            font-weight: normal;
            margin-left: 10px;
        }
        
        /* ▼▼▼ スマートフォン表示用の修正 ▼▼▼ */
        @media (max-width: 768px) {
            /* bodyの左右の余白（グレー部分）をなくします */
            body { 
                padding: 0;
            }
            
            /* コンテナを縦並びにし、画面いっぱいに広げます */
            .main-container { 
                flex-direction: column; 
                align-items: center; 
                gap: 0; /* 隙間をなくして一体感を出す */
                width: 100%;
            }

            /* ゲームとサイドバーの要素を画面幅いっぱいに設定します */
            #game-wrapper, #start-screen, #game-container, #sidebar { 
                width: 100%; 
                max-width: 100%; /* 最大幅の制限を解除 */
                box-sizing: border-box;
                border-radius: 0; /* 画面端に合わせるため角丸をリセット */
                box-shadow: none; /* 個別の影をリセット */
            }

            /* 上下の要素との区切り線として、間に余白と線を設定 */
            #sidebar {
                margin-top: 0;
                border-top: 8px solid #f0f2f5; /* bodyと同じ背景色で区切りを作る */
            }
        }
        /* ▲▲▲ スマートフォン表示用の修正 ▲▲▲ */
    </style>
</head>
<body>

    <div class="main-container">

        <div id="game-wrapper">
            <div id="start-screen">
                <h1>コンデンサコード入力ゲーム</h1>
                <button id="start-button">ゲームスタート</button>
            </div>
            <div id="game-container" class="hidden">
                <div id="countdown-overlay" class="hidden"></div>
                <div id="info-panel">
                    <div id="score-container">スコア: <span id="score">0</span></div>
                    <div id="timer-container">残り時間: <span id="timer">60</span>秒</div>
                </div>
                <div id="capacitor-container">
                    <div id="capacitor-value">0.1µF</div>
                </div>
                <div id="display-panel">
                    <div id="input-display"></div>
                    <div id="feedback"></div>
                </div>
                <div id="keypad">
                    <button class="key num-key">1</button>
                    <button class="key num-key">2</button>
                    <button class="key num-key">3</button>
                    <button class="key num-key">4</button>
                    <button class="key num-key">5</button>
                    <button class="key num-key">6</button>
                    <button class="key num-key">7</button>
                    <button class="key num-key">8</button>
                    <button class="key num-key">9</button>
                    <button class="key clear-key">C</button>
                    <button class="key num-key">0</button>
                    <button class="key enter-key">決定</button>
                </div>
            </div>
            <div id="game-over-modal" class="hidden">
                <div class="modal-content">
                    <h2>ゲームオーバー！</h2>
                    <p>最終スコア: <span id="final-score"></span></p>
                    <button id="restart-button">もう一度プレイ</button>
                </div>
            </div>
        </div>
        <div id="sidebar">
            <div class="sidebar-section">
                <h2>🏆 本日の最高得点</h2>
                <div id="today-best-score-wrapper">
                    <p id="today-best-score" class="score-display">まだ記録がありません</p>
                </div>
            </div>
            <div class="sidebar-section">
                <h2>📈 今日のランキング</h2>
                <ol id="ranking-list">
                    <li>まだ記録がありません</li>
                </ol>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const startScreenEl = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            const gameContainerEl = document.getElementById('game-container');
            const countdownOverlayEl = document.getElementById('countdown-overlay');
            const scoreEl = document.getElementById('score');
            const timerEl = document.getElementById('timer');
            const capacitorValueEl = document.getElementById('capacitor-value');
            const inputDisplayEl = document.getElementById('input-display');
            const feedbackEl = document.getElementById('feedback');
            const keypadEl = document.getElementById('keypad');
            const gameOverModalEl = document.getElementById('game-over-modal');
            const finalScoreEl = document.getElementById('final-score');
            const restartButton = document.getElementById('restart-button');
            const todayBestScoreWrapperEl = document.getElementById('today-best-score-wrapper');
            const todayBestScoreEl = document.getElementById('today-best-score');
            const rankingListEl = document.getElementById('ranking-list');

            // --- Game Constants ---
            const TODAY_RANKING_KEY = 'capacitorCodeGameTodayRanking';
            const TODAY_BEST_KEY = 'capacitorCodeGameTodayBest';
            const GAME_DURATION = 60;
            const COUNTDOWN_SECONDS = 3;
            const E12_VALUES = ['10', '12', '15', '18', '22', '27', '33', '39', '47', '56', '68', '82'];

            // --- Game State ---
            let score, timeLeft, timerInterval, currentCorrectCode, playerInput;
            let isGameActive = false;
            let feedbackTimeoutId;

            function generateQuestion() {
                const baseValue = E12_VALUES[Math.floor(Math.random() * E12_VALUES.length)];
                const multiplier = Math.floor(Math.random() * 6); // 10^0 to 10^5
                const capacitancePf = parseInt(baseValue) * Math.pow(10, multiplier);

                capacitorValueEl.textContent = formatCapacitanceForDisplay(capacitancePf);
                currentCorrectCode = calculateCode(baseValue, multiplier);
            }

            function calculateCode(base, exp) {
                return `${base}${exp}`;
            }
            
            // ★★★ 10000pF以上はuFで表示するよう修正 ★★★
            function formatCapacitanceForDisplay(pf) {
                const cleanValue = parseFloat(pf.toPrecision(12));
                if (cleanValue >= 10000) { //しきい値を10000に変更
                    return `${parseFloat((cleanValue / 1000000).toPrecision(12))}µF`;
                }
                return `${cleanValue}pF`;
            }

            function handleKeyPress(key) {
                if (!isGameActive) return;

                if (key === 'C') {
                    playerInput = '';
                } else if (key === '決定') {
                    if (playerInput.length === 3) {
                        checkAnswer();
                    }
                } else if (playerInput.length < 3) {
                    playerInput += key;
                }
                updateDisplay();
            }

            function updateDisplay() {
                inputDisplayEl.textContent = playerInput;
            }
            
            function checkAnswer() {
                if (!isGameActive) return;

                isGameActive = false;
                clearTimeout(feedbackTimeoutId);
                
                if (playerInput === currentCorrectCode) {
                    score += 10;
                    feedbackEl.textContent = "正解！ 🎉";
                    feedbackEl.className = 'correct';
                } else {
                    score = Math.max(0, score - 10);
                    feedbackEl.textContent = `残念！正解は「${currentCorrectCode}」でした。`;
                    feedbackEl.className = 'incorrect';
                }
                
                scoreEl.textContent = score;
                
                feedbackTimeoutId = setTimeout(() => {
                    if (timerInterval) {
                        playerInput = '';
                        updateDisplay();
                        feedbackEl.textContent = '';
                        generateQuestion();
                        isGameActive = true;
                    }
                }, 1200);
            }

            function startCountdown() {
                startScreenEl.classList.add('hidden');
                gameOverModalEl.classList.add('hidden');
                gameContainerEl.classList.remove('hidden');
                countdownOverlayEl.classList.remove('hidden');
                
                let count = COUNTDOWN_SECONDS;
                countdownOverlayEl.textContent = count;
                
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownOverlayEl.textContent = count;
                    } else {
                        clearInterval(countdownInterval);
                        countdownOverlayEl.classList.add('hidden');
                        setTimeout(runGame, 10);  
                    }
                }, 1000);
            }
            
            function runGame() {
                isGameActive = true;
                score = 0;
                timeLeft = GAME_DURATION;
                playerInput = '';
                
                clearTimeout(feedbackTimeoutId);
                if(timerInterval) clearInterval(timerInterval);

                scoreEl.textContent = score;
                timerEl.textContent = timeLeft;
                feedbackEl.textContent = '';
                updateDisplay();
                
                generateQuestion();

                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            }

            function endGame() {
                isGameActive = false;
                clearInterval(timerInterval);
                timerInterval = null;
                clearTimeout(feedbackTimeoutId);
                timerEl.textContent = 0;
                
                finalScoreEl.innerHTML = `${score} 点 <span class="timestamp">(${formatTimestamp(Date.now())})</span>`;
                gameOverModalEl.classList.remove('hidden');

                saveScores(score);
                updateSidebar();
            }

            function formatTimestamp(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${month}/${day} ${hours}:${minutes}`;
            }
            
            function getTodayDateString() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }

            function saveScores(newScore) {
                if (newScore <= 0) return;
                
                const timestamp = Date.now();
                const today = getTodayDateString();
                const scoreEntry = { score: newScore, ts: timestamp };

                let todayRankingData = JSON.parse(localStorage.getItem(TODAY_RANKING_KEY)) || { date: '', scores: [] };
                if (todayRankingData.date !== today) {
                    todayRankingData = { date: today, scores: [] };
                }
                todayRankingData.scores.push(scoreEntry);
                todayRankingData.scores.sort((a, b) => b.score - a.score);
                todayRankingData.scores = todayRankingData.scores.slice(0, 5);
                localStorage.setItem(TODAY_RANKING_KEY, JSON.stringify(todayRankingData));

                const todayBestData = JSON.parse(localStorage.getItem(TODAY_BEST_KEY)) || { score: 0, date: '' };
                if (todayBestData.date !== today || newScore > todayBestData.score) {
                    localStorage.setItem(TODAY_BEST_KEY, JSON.stringify({ score: newScore, date: today, ts: timestamp }));
                }
            }

            function updateSidebar() {
                const today = getTodayDateString();

                const todayRankingData = JSON.parse(localStorage.getItem(TODAY_RANKING_KEY)) || { date: '', scores: [] };
                rankingListEl.innerHTML = ''; 
                if (todayRankingData.date === today && todayRankingData.scores.length > 0) {
                    todayRankingData.scores.forEach((entry, index) => {
                        const li = document.createElement('li');
                        const scoreSpan = document.createElement('span');
                        const timeSpan = document.createElement('span');

                        const medals = ['🥇', '🥈', '🥉'];
                        scoreSpan.innerHTML = index < 3 ? `${medals[index]} ${entry.score} 点` : `${"&nbsp;".repeat(4)} ${entry.score} 点`;
                        
                        timeSpan.className = 'timestamp';
                        timeSpan.textContent = formatTimestamp(entry.ts);
                        
                        li.appendChild(scoreSpan);
                        li.appendChild(timeSpan);
                        rankingListEl.appendChild(li);
                    });
                } else {
                    rankingListEl.innerHTML = '<li>まだ記録がありません</li>';
                }

                const todayBestData = JSON.parse(localStorage.getItem(TODAY_BEST_KEY)) || { score: 0, date: '' };
                todayBestScoreWrapperEl.innerHTML = ''; 
                if (todayBestData.date === today && todayBestData.score > 0) {
                    todayBestScoreEl.textContent = `${todayBestData.score} 点`;
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'timestamp';
                    timeSpan.textContent = `(${formatTimestamp(todayBestData.ts)})`;
                    todayBestScoreWrapperEl.appendChild(todayBestScoreEl);
                    todayBestScoreWrapperEl.appendChild(timeSpan);
                } else {
                    todayBestScoreEl.textContent = 'まだ記録がありません';
                    todayBestScoreWrapperEl.appendChild(todayBestScoreEl);
                }
            }
            
            // --- Event Listeners ---
            startButton.addEventListener('click', startCountdown);
            restartButton.addEventListener('click', startCountdown);

            keypadEl.addEventListener('click', (e) => {
                if (e.target.matches('button.key:not(:disabled)')) {
                    const key = e.target.textContent;
                    if (key.trim() !== '') {
                        handleKeyPress(key);
                    }
                }
            });

            // --- Initial Setup ---
            updateSidebar();
        });
    </script>
</body>
</html>